// æ–‡ç« å¡ç‰‡æ•°æ®ï¼ˆä» md ç²—æå–æ ‡é¢˜/æ‘˜è¦/æ—¶é•¿ï¼‰

///|
struct ArticleCard {
  name : String
  title : String
  subtitle : String
  minutes : Int
  content : String
  loaded : Bool
  error : String?
}

///|
enum ArticleMsg {
  LoadList
  ListLoaded(Result[@list.List[String], String])
  LoadOne(String)
  OneLoaded(String, Result[String, String])
  LoadMore // æ–°å¢ï¼šåŠ è½½æ›´å¤š
  NoOp
}

///|
struct ArticleModel {
  phase : String
  loading : Bool
  error : String?
  names : @list.List[String]
  items : @list.List[ArticleCard]
  page_size : Int // æ¯æ‰¹åŠ è½½æ•°é‡
  loaded_count : Int // å·²ç»å‘èµ·åŠ è½½çš„æ•°é‡
}

///|
fn article_src_url(name : String) -> String {
  // ç®€å•æ‹¼æ¥ï¼›å¦‚éœ€ç¼–ç ï¼Œåœ¨è¿™é‡Œç»Ÿä¸€ encodeï¼ˆå¦‚æœæœ‰å¯ç”¨çš„ç¼–ç å‡½æ•°ï¼‰
  "https://gitcode.com/weixin_41992365/MoonBitBlog/blob/main/articles/" + name
}

///|
fn trim_simple(s : String) -> String {
  // ç®€æ˜“å»ç©ºç™½ï¼šå»æ‰é¦–å°¾çš„ç©ºæ ¼ã€åˆ¶è¡¨ç¬¦ã€å›è½¦ã€æ¢è¡Œ
  let mut start = 0
  let mut end = s.length()
  // å‰å‘
  while start < end {
    let c = s.at(start)
    if c == ' ' || c == '\t' || c == '\r' || c == '\n' {
      start = start + 1
    } else {
      break
    }
  }
  // åå‘
  while end > start {
    let c = s.at(end - 1)
    if c == ' ' || c == '\t' || c == '\r' || c == '\n' {
      end = end - 1
    } else {
      break
    }
  }
  s.unsafe_substring(start~, end~)
}

///|
fn starts_with_str(s : String, prefix : String) -> Bool {
  if prefix.length() > s.length() {
    return false
  }
  s.unsafe_substring(start=0, end=prefix.length()) == prefix
}

///|
fn batchLoadRange(
  names : @list.List[String],
  start : Int,
  count : Int,
) -> (@tea.Cmd[ArticleMsg], Int) {
  // ä» names ä¸­å–å­åŒºé—´
  let total = names.length()
  if start >= total || count <= 0 {
    return (@tea.none(), 0)
  }
  let mut cmds : @list.List[@tea.Cmd[ArticleMsg]] = @list.of([])
  let mut i = 0
  let mut taken = 0
  // çº¿æ€§èµ°ä¸€éï¼Œå– [start, start+count)
  for name in names.iter() {
    if i >= start && taken < count {
      cmds = cmds.add(getArticleDetailBy(name))
      taken = taken + 1
    }
    i = i + 1
    if taken >= count {
      break
    }
  }
  let batch = @tea.batch(cmds.to_array())
  (batch, taken)
}

///|
fn split_lines(text : String) -> @list.List[String] {
  // æ‰‹å†™åˆ†è¡Œï¼Œæ”¯æŒ \n å’Œ \r\n
  let mut acc : @list.List[String] = @list.of([])
  let mut i = 0
  let n = text.length()
  let mut line_start = 0
  while i < n {
    let ch = text.at(i)
    if ch == '\n' {
      acc = acc.add(text.unsafe_substring(start=line_start, end=i))
      i = i + 1
      line_start = i
    } else if ch == '\r' {
      acc = acc.add(text.unsafe_substring(start=line_start, end=i))
      // è·³è¿‡ \r\n çš„ \n
      if i + 1 < n && text.at(i + 1) == '\n' {
        i = i + 2
      } else {
        i = i + 1
      }
      line_start = i
    } else {
      i = i + 1
    }
  }
  // å°¾è¡Œ
  if line_start <= n {
    acc = acc.add(text.unsafe_substring(start=line_start, end=n))
  }
  acc
}

///|
fn getArticleNamesText() -> @tea.Cmd[ArticleMsg] {
  @http.get(
    "/raw/main/articels.config",
    expect=Text(fn(res : Result[String, String]) -> ArticleMsg {
      match res {
        Ok(t) => {
          let lines = split_lines(t)
          // æ‰‹åŠ¨æ„å»º namesï¼štrim + è¿‡æ»¤ç©ºè¡Œä¸ # æ³¨é‡Š
          let mut names : @list.List[String] = @list.of([])
          for line in lines.iter() {
            let s = trim_simple(line)
            if s != "" && !starts_with_str(s, "#") {
              names = names.add(s)
            }
          }
          ListLoaded(Ok(names))
        }
        Err(e) => ListLoaded(Err(e))
      }
    }),
  )
}

///|
fn getArticleDetailBy(name : String) -> @tea.Cmd[ArticleMsg] {
  let path = "/raw/main/articles/" + name
  @http.get(
    path,
    expect=Text(fn(res : Result[String, String]) -> ArticleMsg {
      OneLoaded(name, res)
    }),
  )
}

///|
fn renderCard(card : ArticleCard) -> @html.Html[ArticleMsg] {
  let content = card.content
  let lines = content.split("\n").to_array()
  // æ ‡é¢˜ï¼šå–é¦–è¡Œå¹¶æ¸…ç†äº•å·ä¸ç©ºç™½
  let title = if lines.length() > 0 {
    lines[0].replace_all(old="#", new="")
  } else {
    "æ ‡é¢˜"
  }

  // æ‘˜è¦ï¼šå–ç¬¬äºŒè¡Œ
  let subtitle = if lines.length() > 1 {
    lines[1].replace_all(old="#", new="")
  } else {
    "å‰¯æ ‡é¢˜"
  }
  div(class="article-card", [
    // å¯é€‰å°é¢
    // div(class="article-image", [text(card.name.replace_all(old=".md", new=""))]),
    div(class="article-content", [
      div(class="article-image", [
        text(card.name.replace_all(old=".md", new="")),
      ]),
      div(class="article-meta", [
        span([text("ğŸ“… ä»Šæ—¥")]),
        span([text("â±ï¸ " + card.minutes.to_string() + "åˆ†é’Ÿé˜…è¯»")]),
      ]),
      @html.a(class="article-title", href="#", [text(title.to_string())]),
      @html.p(class="article-excerpt", [text(subtitle.to_string())]),
      @html.a(
        class="read-more",
        style=[
          "margin-top:auto;align-self:flex-start;display:inline-block;color:#667eea;text-decoration:none;font-weight:600;transition:color 0.3s ease;",
        ],
        href=article_src_url(card.name),
        [text("é˜…è¯»å…¨æ–‡")],
      ),
    ]),
  ])
}

///|
fn articleListView(model : ArticleModel) -> @html.Html[ArticleMsg] {
  div([
    if model.phase == "list" && model.loading {
      div([text("æ­£åœ¨åŠ è½½æ–‡ç« åˆ—è¡¨...")])
    } else if model.error.is_some() {
      div([text(model.error.unwrap())])
    } else {
      div([
        // å¡ç‰‡ç½‘æ ¼
        div(
          class="articles-grid",
          [
            ..model.names.map(fn(name) {
              let c = get_card(model.items, name)
              match c {
                Some(card) =>
                  if card.loaded && card.error.is_none() {
                    renderCard(card)
                  } else if card.loaded {
                    div(class="article-card", [
                      div(class="article-image", [text(card.name)]),
                      div(class="article-content", [
                        @html.p(class="article-excerpt", [text("åŠ è½½å¤±è´¥")]),
                        // æä¾›é‡è¯•
                        @html.button(click=LoadOne(card.name), [text("é‡è¯•")]),
                      ]),
                    ])
                  } else {
                    div(class="article-card", [
                      div(class="article-content", [
                        @html.p(class="article-excerpt", [text("åŠ è½½ä¸­...")]),
                      ]),
                    ])
                  }
                None =>
                  // è¶…å‡ºå·²åŠ è½½èŒƒå›´çš„ä¸æ¸²æŸ“æˆ–ç»™å ä½
                  div([])
              }
            }),
          ],
        ),
        // åŠ è½½æ›´å¤šæŒ‰é’®
        if model.names.length() > model.loaded_count {
          @html.div(class="load-more-wrap", [
            @html.button(click=LoadMore, class="load-more-btn", [
              text(if model.loading { "åŠ è½½ä¸­..." } else { "åŠ è½½æ›´å¤š" }),
            ]),
          ])
        } else {
          @html.div([text("å·²åˆ°åº•éƒ¨")]) // æ²¡æœ‰æ›´å¤šäº†ï¼Œå¯æ¢æˆæç¤ºæ–‡æœ¬
        },
      ])
    },
  ])
}

///|
fn initArticles() -> (@tea.Cmd[ArticleMsg], ArticleModel) {
  (
    getArticleNamesText(),
    {
      phase: "list",
      loading: true,
      error: None,
      names: @list.of([]),
      items: @list.of([]),
      page_size: 6, // é»˜è®¤æ¯æ¬¡åŠ è½½ 6 ç¯‡ï¼Œå¯è‡ªè¡Œä¿®æ”¹
      loaded_count: 0,
    },
  )
}

///|
fn upsert_card(
  items : @list.List[ArticleCard],
  card : ArticleCard,
) -> @list.List[ArticleCard] {
  // çº¿æ€§æŸ¥æ‰¾å¹¶æ›¿æ¢ï¼›è‹¥ä¸å­˜åœ¨åˆ™ push
  let mut found = false
  let mut out : @list.List[ArticleCard] = @list.of([])
  for it in items.iter() {
    if it.name == card.name {
      out = out.add(card)
      found = true
    } else {
      out = out.add(it)
    }
  }
  if !found {
    out = out.add(card)
  }
  out
}

///|
fn get_card(items : @list.List[ArticleCard], name : String) -> ArticleCard? {
  for it in items.iter() {
    if it.name == name {
      return Some(it)
    }
  }
  None
}

///|
fn articleUpdate(
  msg : ArticleMsg,
  model : ArticleModel,
) -> (@tea.Cmd[ArticleMsg], ArticleModel) {
  match msg {
    LoadList =>
      (
        getArticleNamesText(),
        { ..model, phase: "list", loading: true, error: None, loaded_count: 0 },
      )
    ListLoaded(result) =>
      match result {
        Ok(names) => {
          // é¦–æ‰¹ï¼šåªåŠ è½½ page_size ä¸ª
          let (batch, taken) = batchLoadRange(names, 0, model.page_size)
          (
            batch,
            {
              ..model,
              names,
              loading: true,
              phase: "items",
              error: None,
              loaded_count: taken, // å·²è¯·æ±‚æ•°é‡
            },
          )
        }
        Err(e) =>
          (
            @tea.none(),
            { ..model, loading: false, error: Some("åˆ—è¡¨åŠ è½½å¤±è´¥: " + e) },
          )
      }

    // ç»§ç»­åŠ è½½ä¸‹ä¸€æ‰¹
    LoadMore => {
      let start = model.loaded_count
      let (batch, taken) = batchLoadRange(model.names, start, model.page_size)
      if taken == 0 {
        // æ²¡æœ‰æ›´å¤šäº†
        (@tea.none(), { ..model, loading: false })
      } else {
        (batch, { ..model, loading: true, loaded_count: start + taken })
      }
    }
    OneLoaded(name, result) =>
      match result {
        Ok(md) => {
          let lines = split_lines(md)
          let mut minutes = md.length() / 800 + 1
          if minutes < 1 {
            minutes = 1
          }
          let title = if lines.length() > 0 {
            trim_simple(lines.unsafe_head().replace_all(old="#", new=""))
          } else {
            "æœªå‘½åæ–‡ç« "
          }
          let subtitle = if lines.length() > 1 {
            trim_simple(lines.unsafe_nth(1).replace_all(old="#", new=""))
          } else {
            ""
          }
          let new_card = {
            name,
            title: if title == "" {
              "æœªå‘½åæ–‡ç« "
            } else {
              title
            },
            subtitle,
            minutes,
            content: md,
            loaded: true,
            error: None,
          }
          let items2 = upsert_card(model.items, new_card)

          // åˆ¤æ–­å½“å‰å·²è¯·æ±‚èŒƒå›´å†…æ˜¯å¦éƒ½å®Œæˆï¼ˆå¯ä¿æŒåŸé€»è¾‘ï¼‰
          let mut done = true
          // åªæ£€æŸ¥å‰ loaded_count ä¸ªåå­—æ›´åˆç†
          let mut i = 0
          for n in model.names.iter() {
            if i >= model.loaded_count {
              break
            }
            let c = get_card(items2, n)
            match c {
              Some(card) => if !card.loaded { done = false }
              None => done = false
            }
            i = i + 1
          }
          (
            @tea.none(),
            {
              ..model,
              items: items2,
              loading: !done,
              phase: if done {
                "items"
              } else {
                "items"
              },
            },
          )
        }
        Err(e) => {
          let new_card = {
            name,
            title: "",
            subtitle: "",
            minutes: 1,
            content: "",
            loaded: true,
            error: Some(e),
          }
          let items2 = upsert_card(model.items, new_card)
          (@tea.none(), { ..model, items: items2 })
        }
      }
    LoadOne(name) =>
      // æ‰‹åŠ¨é‡è¯•å•ç¯‡
      (getArticleDetailBy(name), { ..model, loading: true })
    NoOp => (@tea.none(), model)
  }
}

///|
fn startArticlesApp() -> Unit {
  fn initialize(url : @url.Url) -> (@tea.Cmd[ArticleMsg], ArticleModel) {
    initArticles()
  }

  @tea.application(
    initialize~,
    update=articleUpdate,
    view=articleListView,
    mount="articlesContainer",
  )
}

///|
/// å¯åŠ¨
fn main {
  startArticlesApp()
}
